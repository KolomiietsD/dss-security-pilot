{% extends "base.html" %}

{% block title %}CrowdStrike{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-3">CrowdStrike – хости</h1>

    <!-- Блок помилки -->
    <div id="error-block" class="alert alert-danger d-none"></div>

    <!-- Loader -->
    <div id="loader" class="d-flex align-items-center mb-3">
        <div class="spinner-border me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Завантаження даних з CrowdStrike…</span>
    </div>

    <!-- Блок інфографіки -->
    <div class="row mb-4 g-3">

        <!-- 1. Статуси -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">
                    <strong>Статус хостів</strong>
                </div>
                <div class="card-body p-2" style="height: 180px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 2. Платформи -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">
                    <strong>Платформи хостів</strong>
                </div>
                <div class="card-body p-2" style="height: 180px;">
                    <canvas id="platformChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 3. Останній зв'язок -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">
                    <strong>Останній зв'язок з хостами</strong>
                </div>
                <div class="card-body p-2" style="height: 180px;">
                    <canvas id="lastSeenChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблиця хостів -->
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>#</th>
                <th>Hostname</th>
                <th>Платформа</th>
                <th>IP</th>
                <th>Last seen</th>
                <th>Онлайн</th>
            </tr>
        </thead>
        <tbody id="devices-tbody">
            <!-- JS додає -->
        </tbody>
    </table>

    <p id="no-data-msg" class="d-none">
        Немає даних з CrowdStrike (немає хостів або проблема з доступом).
    </p>
</div>

<!-- ================= DETECTS ================= -->

<h2 class="h5 mt-4 mb-2">Останні детекції CrowdStrike</h2>

<div id="detects-loader" class="d-flex align-items-center mb-2">
    <div class="spinner-border spinner-border-sm me-2" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <span>Завантаження детекцій…</span>
</div>

<div id="detects-error" class="alert alert-danger d-none"></div>

<div class="table-responsive">
    <table class="table table-sm table-hover align-middle">
        <thead>
            <tr>
                <th>Час</th>
                <th>Hostname</th>
                <th>Severity</th>
                <th>Score</th>
                <th>Тип</th>
                <th>Продукт</th>
                <th>Платформа</th>
                <th>Мітки</th>
                <th>Статус</th>
                <th>Опис</th>
            </tr>
        </thead>
        <tbody id="detects-tbody">
            <!-- JS додає -->
        </tbody>
    </table>
</div>

<p id="detects-empty" class="text-muted d-none">
    Поки що немає детекцій для відображення.
</p>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    /* ================= HOSTS ================= */

    const loader = document.getElementById("loader");
    const errorBlock = document.getElementById("error-block");
    const tbody = document.getElementById("devices-tbody");
    const noDataMsg = document.getElementById("no-data-msg");

    const devicesUrl = "/crowdstrike/data/";

    const statusChartCanvas = document.getElementById("statusChart");
    const platformChartCanvas = document.getElementById("platformChart");
    const lastSeenChartCanvas = document.getElementById("lastSeenChart");

    let statusChart = null;
    let platformChart = null;
    let lastSeenChart = null;

    fetch(devicesUrl)
        .then(r => {
            if (!r.ok) throw new Error("HTTP " + r.status);
            return r.json();
        })
        .then(data => {
            loader.classList.add("d-none");

            if (!data.success) {
                errorBlock.textContent = "Помилка: " + (data.error || "Невідома помилка");
                errorBlock.classList.remove("d-none");
                noDataMsg.classList.remove("d-none");
                return;
            }

            const devices = data.devices || [];
            if (!devices.length) {
                noDataMsg.classList.remove("d-none");
                return;
            }

            const statusCounts = { online: 0, offline: 0, unknown: 0 };
            const platformCounts = {};
            const lastSeenBuckets = { "≤ 24 год": 0, "1–7 днів": 0, "> 7 днів": 0 };

            const now = new Date();

            devices.forEach((d, idx) => {
                const tr = document.createElement("tr");

                function td(v) {
                    const e = document.createElement("td");
                    e.textContent = v || "";
                    return e;
                }

                tr.appendChild(td(idx + 1));
                tr.appendChild(td(d.hostname));
                tr.appendChild(td(d.platform_name));
                tr.appendChild(td(d.local_ip));
                tr.appendChild(td(d.last_seen));

                // статус
                const tdSt = document.createElement("td");
                const badge = document.createElement("span");
                const st = d.online_status;

                if (st === "online") {
                    badge.className = "badge text-bg-success";
                    badge.textContent = "Online";
                    statusCounts.online++;
                } else if (st === "offline") {
                    badge.className = "badge text-bg-secondary";
                    badge.textContent = "Offline";
                    statusCounts.offline++;
                } else {
                    badge.className = "badge text-bg-warning";
                    badge.textContent = "Unknown";
                    statusCounts.unknown++;
                }

                tdSt.appendChild(badge);
                tr.appendChild(tdSt);
                tbody.appendChild(tr);

                const plat = d.platform_name || "Unknown";
                platformCounts[plat] = (platformCounts[plat] || 0) + 1;

                if (d.last_seen) {
                    const dt = new Date(d.last_seen);
                    const diff = (now - dt) / (1000 * 60 * 60 * 24);
                    if (diff <= 1) lastSeenBuckets["≤ 24 год"]++;
                    else if (diff <= 7) lastSeenBuckets["1–7 днів"]++;
                    else lastSeenBuckets["> 7 днів"]++;
                } else {
                    lastSeenBuckets["> 7 днів"]++;
                }
            });

            // Charts
            const ctx1 = statusChartCanvas.getContext("2d");
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(ctx1, {
                type: "doughnut",
                data: {
                    labels: ["Online", "Offline", "Unknown"],
                    datasets: [{ data: [statusCounts.online, statusCounts.offline, statusCounts.unknown] }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: "bottom" } }
                }
            });

            const platforms = Object.keys(platformCounts);
            const pvals = platforms.map(p => platformCounts[p]);
            const ctx2 = platformChartCanvas.getContext("2d");
            if (platformChart) platformChart.destroy();
            platformChart = new Chart(ctx2, {
                type: "bar",
                data: { labels: platforms, datasets: [{ data: pvals }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const lsLabels = Object.keys(lastSeenBuckets);
            const lsVals = lsLabels.map(l => lastSeenBuckets[l]);
            const ctx3 = lastSeenChartCanvas.getContext("2d");
            if (lastSeenChart) lastSeenChart.destroy();
            lastSeenChart = new Chart(ctx3, {
                type: "bar",
                data: { labels: lsLabels, datasets: [{ data: lsVals }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

        })
        .catch(err => {
            loader.classList.add("d-none");
            errorBlock.textContent = "Помилка: " + err.message;
            errorBlock.classList.remove("д-none");
            noDataMsg.classList.remove("d-none");
        });

    /* ================= DETECTS ================= */

    const detectsUrl = "/crowdstrike/detects/";

    const detectsLoader = document.getElementById("detects-loader");
    const detectsError = document.getElementById("detects-error");
    const detectsTbody = document.getElementById("detects-tbody");
    const detectsEmpty = document.getElementById("detects-empty");

    fetch(detectsUrl)
        .then(r => {
            if (!r.ok) throw new Error("HTTP " + r.status);
            return r.json();
        })
        .then(data => {
            detectsLoader.classList.add("d-none");

            if (!data.success) {
                detectsError.textContent = "Помилка: " + (data.error || "Невідома помилка");
                detectsError.classList.remove("d-none");
                detectsEmpty.classList.remove("d-none");
                return;
            }

            const detects = data.detects || [];
            if (!detects.length) {
                detectsEmpty.classList.remove("d-none");
                return;
            }

            detects.sort((a, b) => {
                const ta = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                const tb = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                return tb - ta;
            });

            detects.forEach(ev => {
                const tr = document.createElement("tr");

                // службові ID для майбутнього (модалка / drill-down)
                if (ev.detection_id) {
                    tr.dataset.detectionId = ev.detection_id;
                }
                if (ev.device_id) {
                    tr.dataset.deviceId = ev.device_id;
                }

                function td(v) {
                    const e = document.createElement("td");
                    e.textContent = (v !== undefined && v !== null) ? v : "";
                    return e;
                }

                // Час
                tr.appendChild(td(ev.timestamp));
                // Hostname
                tr.appendChild(td(ev.hostname));

                // Severity з бейджем
                const tdSev = document.createElement("td");
                const sevSpan = document.createElement("span");
                const sevValue = ev.severity;
                const sev = (typeof sevValue === "string"
                    ? sevValue
                    : String(sevValue || "")
                ).toLowerCase();

                if (sev === "critical") {
                    sevSpan.className = "badge text-bg-danger";
                } else if (sev === "high") {
                    sevSpan.className = "badge text-bg-warning";
                } else if (sev === "medium") {
                    sevSpan.className = "badge text-bg-info";
                } else if (sev === "low") {
                    sevSpan.className = "badge text-bg-secondary";
                } else {
                    sevSpan.className = "badge text-bg-light text-dark";
                }

                sevSpan.textContent = ev.severity || "—";
                tdSev.appendChild(sevSpan);
                tr.appendChild(tdSev);

                // Score (severity_score)
                tr.appendChild(td(ev.severity_score));

                // Тип
                tr.appendChild(td(ev.type));

                // Продукт
                tr.appendChild(td(ev.product));

                // Платформа
                tr.appendChild(td(ev.platform));

                // Мітки
                const flagsTd = document.createElement("td");
                let hasFlag = false;

                if (ev.is_lateral_movement) {
                    const badgeLat = document.createElement("span");
                    badgeLat.className = "badge rounded-pill text-bg-primary me-1";
                    badgeLat.textContent = "Lateral";
                    flagsTd.appendChild(badgeLat);
                    hasFlag = true;
                }

                if (ev.is_ransomware_like) {
                    const badgeRan = document.createElement("span");
                    badgeRan.className = "badge rounded-pill text-bg-danger me-1";
                    badgeRan.textContent = "Ransomware";
                    flagsTd.appendChild(badgeRan);
                    hasFlag = true;
                }

                if (!hasFlag) {
                    flagsTd.textContent = "—";
                }

                tr.appendChild(flagsTd);

                // Статус
                tr.appendChild(td(ev.status));

                // Опис
                tr.appendChild(td(ev.description));

                detectsTbody.appendChild(tr);
            });
        })
        .catch(err => {
            detectsLoader.classList.add("d-none");
            detectsError.textContent = "Помилка завантаження: " + err.message;
            detectsError.classList.remove("d-none");
            detectsEmpty.classList.remove("d-none");
        });

});
</script>

{% endblock %}






