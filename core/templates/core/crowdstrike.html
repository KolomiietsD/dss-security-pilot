{% extends "base.html" %}

{% block title %}CrowdStrike{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-3">CrowdStrike – хости</h1>

    <!-- Блок помилки -->
    <div id="error-block" class="alert alert-danger d-none"></div>

    <!-- Loader -->
    <div id="loader" class="d-flex align-items-center mb-3">
        <div class="spinner-border me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Завантаження даних з CrowdStrike…</span>
    </div>

    <!-- Блок з інфографікою -->
    <div class="row mb-4 g-3">
        <!-- 1. Статуси -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">
                    <strong>Статус хостів</strong>
                </div>
                <div class="card-body p-2" style="height: 180px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 2. Платформи -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">
                    <strong>Платформи хостів</strong>
                </div>
                <div class="card-body p-2" style="height: 180px;">
                    <canvas id="platformChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 3. Давність останнього зв'язку -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header py-2">
                    <strong>Останній зв'язок з хостами</strong>
                </div>
                <div class="card-body p-2" style="height: 180px;">
                    <canvas id="lastSeenChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблиця з хостами -->
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>#</th>
                <th>Hostname</th>
                <th>Платформа</th>
                <th>IP</th>
                <th>Last seen</th>
                <th>Онлайн-статус</th>
            </tr>
        </thead>
        <tbody id="devices-tbody">
            <!-- JS сюди додасть рядки -->
        </tbody>
    </table>

    <p id="no-data-msg" class="d-none">
        Немає даних з CrowdStrike (немає хостів або проблема з доступом).
    </p>
</div>

    <h2 class="h5 mt-4 mb-2">Останні події CrowdStrike</h2>

<div id="events-loader" class="d-flex align-items-center mb-2">
    <div class="spinner-border spinner-border-sm me-2" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <span>Завантаження подій…</span>
</div>

<div id="events-error" class="alert alert-danger d-none"></div>

<div class="table-responsive">
    <table class="table table-sm table-hover align-middle">
        <thead>
            <tr>
                <th>Час</th>
                <th>Hostname</th>
                <th>Severity</th>
                <th>Тип</th>
                <th>Опис</th>
                <th>Статус</th>
            </tr>
        </thead>
        <tbody id="events-tbody">
            <!-- JS сюди додасть рядки -->
        </tbody>
    </table>
</div>

<p id="events-empty" class="text-muted d-none">
    Поки що немає подій для відображення.
</p>


<!-- Chart.js з CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const loader = document.getElementById("loader");
    const tbody = document.getElementById("devices-tbody");
    const errorBlock = document.getElementById("error-block");
    const noDataMsg = document.getElementById("no-data-msg");

    const statusChartCanvas = document.getElementById("statusChart");
    const platformChartCanvas = document.getElementById("platformChart");
    const lastSeenChartCanvas = document.getElementById("lastSeenChart");

    let statusChart = null;
    let platformChart = null;
    let lastSeenChart = null;

    // URL-и
    const devicesUrl = "/crowdstrike/data/";
    const eventsUrl = "/crowdstrike/events/";

    // ---------- Хости + графіки ----------
    fetch(devicesUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error("HTTP " + response.status);
            }
            return response.json();
        })
        .then(data => {
            loader.classList.add("d-none");

            if (!data.success) {
                errorBlock.textContent = "Помилка при зверненні до CrowdStrike API: " + (data.error || "Невідома помилка");
                errorBlock.classList.remove("d-none");
                noDataMsg.classList.remove("d-none");
                return;
            }

            const devices = data.devices || [];
            if (devices.length === 0) {
                noDataMsg.classList.remove("d-none");
                return;
            }

            const statusCounts = { online: 0, offline: 0, unknown: 0 };
            const platformCounts = {};
            const lastSeenBuckets = {
                "≤ 24 год": 0,
                "1–7 днів": 0,
                "> 7 днів": 0
            };

            const now = new Date();

            devices.forEach((d, index) => {
                const tr = document.createElement("tr");

                function td(text) {
                    const cell = document.createElement("td");
                    cell.textContent = text || "";
                    return cell;
                }

                tr.appendChild(td(index + 1));
                tr.appendChild(td(d.hostname));
                tr.appendChild(td(d.platform_name));
                tr.appendChild(td(d.local_ip));
                tr.appendChild(td(d.last_seen));

                const tdStatus = document.createElement("td");
                const span = document.createElement("span");
                const st = d.online_status;

                if (st === "online") {
                    span.className = "badge text-bg-success";
                    span.textContent = "Online";
                    statusCounts.online += 1;
                } else if (st === "offline") {
                    span.className = "badge text-bg-secondary";
                    span.textContent = "Offline";
                    statusCounts.offline += 1;
                } else {
                    span.className = "badge text-bg-warning";
                    span.textContent = "Unknown";
                    statusCounts.unknown += 1;
                }

                tdStatus.appendChild(span);
                tr.appendChild(tdStatus);
                tbody.appendChild(tr);

                const platformName = d.platform_name || "Unknown";
                if (!platformCounts[platformName]) {
                    platformCounts[platformName] = 0;
                }
                platformCounts[platformName] += 1;

                if (d.last_seen) {
                    const lastSeenDate = new Date(d.last_seen);
                    if (!isNaN(lastSeenDate.getTime())) {
                        const diffMs = now - lastSeenDate;
                        const diffDays = diffMs / (1000 * 60 * 60 * 24);

                        if (diffDays <= 1) {
                            lastSeenBuckets["≤ 24 год"] += 1;
                        } else if (diffDays <= 7) {
                            lastSeenBuckets["1–7 днів"] += 1;
                        } else {
                            lastSeenBuckets["> 7 днів"] += 1;
                        }
                    } else {
                        lastSeenBuckets["> 7 днів"] += 1;
                    }
                } else {
                    lastSeenBuckets["> 7 днів"] += 1;
                }
            });

            // Графік статусів
            const ctxStatus = statusChartCanvas.getContext("2d");
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(ctxStatus, {
                type: "doughnut",
                data: {
                    labels: ["Online", "Offline", "Unknown"],
                    datasets: [{
                        data: [
                            statusCounts.online,
                            statusCounts.offline,
                            statusCounts.unknown
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: "bottom" },
                        title: { display: false }
                    }
                }
            });

            // Графік платформ
            const platforms = Object.keys(platformCounts);
            const platformValues = platforms.map(p => platformCounts[p]);
            const ctxPlatform = platformChartCanvas.getContext("2d");
            if (platformChart) platformChart.destroy();
            platformChart = new Chart(ctxPlatform, {
                type: "bar",
                data: {
                    labels: platforms,
                    datasets: [{ data: platformValues }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });

            // Графік "останній зв'язок"
            const lastSeenLabels = Object.keys(lastSeenBuckets);
            const lastSeenValues = lastSeenLabels.map(k => lastSeenBuckets[k]);
            const ctxLastSeen = lastSeenChartCanvas.getContext("2d");
            if (lastSeenChart) lastSeenChart.destroy();
            lastSeenChart = new Chart(ctxLastSeen, {
                type: "bar",
                data: {
                    labels: lastSeenLabels,
                    datasets: [{ data: lastSeenValues }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    }
                }
            });

        })
        .catch(error => {
            loader.classList.add("d-none");
            errorBlock.textContent = "Помилка при завантаженні даних: " + error.message;
            errorBlock.classList.remove("d-none");
            noDataMsg.classList.remove("d-none");
        });

    // =============== Події CrowdStrike ===============
    const eventsLoader = document.getElementById("events-loader");
    const eventsError = document.getElementById("events-error");
    const eventsTbody = document.getElementById("events-tbody");
    const eventsEmpty = document.getElementById("events-empty");

    fetch(eventsUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error("HTTP " + response.status);
            }
            return response.json();
        })
        .then(data => {
            eventsLoader.classList.add("d-none");

            if (!data.success) {
                eventsError.textContent = "Помилка при отриманні подій: " + (data.error || "Невідома помилка");
                eventsError.classList.remove("d-none");
                eventsEmpty.classList.remove("d-none");
                return;
            }

            const events = data.events || [];
            if (events.length === 0) {
                eventsEmpty.classList.remove("d-none");
                return;
            }

            // Нехай найсвіжіші будуть зверху (якщо вже відсортовано на бекенді — можна пропустити)
            events.sort((a, b) => {
                const ta = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                const tb = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                return tb - ta;
            });

            events.forEach(ev => {
                const tr = document.createElement("tr");

                function td(text) {
                    const cell = document.createElement("td");
                    cell.textContent = text || "";
                    return cell;
                }

                tr.appendChild(td(ev.timestamp));             // Час
                tr.appendChild(td(ev.hostname));              // Hostname

                // Severity з бейджем
                const sevTd = document.createElement("td");
                const sevSpan = document.createElement("span");
                const sev = (ev.severity || "").toLowerCase();

                if (sev === "critical") {
                    sevSpan.className = "badge text-bg-danger";
                } else if (sev === "high") {
                    sevSpan.className = "badge text-bg-warning";
                } else if (sev === "medium") {
                    sevSpan.className = "badge text-bg-info";
                } else {
                    sevSpan.className = "badge text-bg-secondary";
                }
                sevSpan.textContent = ev.severity || "—";
                sevTd.appendChild(sevSpan);
                tr.appendChild(sevTd);

                tr.appendChild(td(ev.type));                  // Тип
                tr.appendChild(td(ev.description));           // Опис
                tr.appendChild(td(ev.status));                // Статус

                eventsTbody.appendChild(tr);
            });
        })
        .catch(error => {
            eventsLoader.classList.add("d-none");
            eventsError.textContent = "Помилка при завантаженні подій: " + error.message;
            eventsError.classList.remove("d-none");
            eventsEmpty.classList.remove("d-none");
        });
});
</script>

{% endblock %}


