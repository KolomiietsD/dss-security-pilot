{% extends "base.html" %}

{% block title %}Активи{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-3">Активи</h1>

    <p class="text-muted mb-2">
        Короткий список хостів (зараз тільки з CrowdStrike).
    </p>

    <!-- Блок для помилок -->
    <div id="error-block" class="alert alert-danger d-none"></div>

    <!-- Loader -->
    <div id="loader" class="d-flex align-items-center mb-2">
        <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Завантаження списку активів…</span>
    </div>

    <!-- Малесенький список: тільки № і hostname -->
    <div class="card" style="max-width: 400px;">
        <div class="card-body p-2">
            <ul id="assets-list" class="list-group list-group-flush small">
                <!-- JS сюди додасть елементи -->
            </ul>
        </div>
    </div>

    <p id="no-data-msg" class="text-muted mt-2 d-none">
        Поки що немає даних про активи.
    </p>
</div>

    <!-- Модальне вікно з інформацією про актив -->
<div class="modal fade" id="assetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title" id="assetModalTitle">Актив</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-2">
        <dl class="row mb-0 small">
          <dt class="col-4">Hostname</dt>
          <dd class="col-8" id="md-hostname"></dd>

          <dt class="col-4">IP</dt>
          <dd class="col-8" id="md-ip"></dd>

          <dt class="col-4">Платформа</dt>
          <dd class="col-8" id="md-platform"></dd>

          <dt class="col-4">Вендор</dt>
          <dd class="col-8" id="md-vendor"></dd>

          <dt class="col-4">Статус</dt>
          <dd class="col-8" id="md-status"></dd>

          <dt class="col-4">Ризик</dt>
          <dd class="col-8" id="md-risk"></dd>
        </dl>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Закрити</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const loader = document.getElementById("loader");
    const errorBlock = document.getElementById("error-block");
    const noDataMsg = document.getElementById("no-data-msg");
    const list = document.getElementById("assets-list");

    // тут будемо тримати всі активи, щоб по кліку знайти потрібний
    let assetsData = [];

    // якщо в urls.py є name='assets_data', можна так:
    // const url = "{% url 'assets_data' %}";
    const url = "/assets/data/";

    function showAssetModal(asset) {
        document.getElementById("assetModalTitle").textContent =
            asset.hostname || "Актив";

        document.getElementById("md-hostname").textContent = asset.hostname || "—";
        document.getElementById("md-ip").textContent = asset.ip || "—";
        document.getElementById("md-platform").textContent = asset.platform || "—";
        document.getElementById("md-vendor").textContent = asset.vendor || "—";

        let statusText = "—";
        if (asset.online_status === "online") statusText = "Online";
        else if (asset.online_status === "offline") statusText = "Offline";
        else if (asset.online_status === "unknown") statusText = "Unknown";
        document.getElementById("md-status").textContent = statusText;

        let riskText = "—";
        if (asset.risk_score != null) {
            riskText = (asset.risk_score * 100).toFixed(0) + " %";
        }
        document.getElementById("md-risk").textContent = riskText;

        // показуємо Bootstrap-модалку
        const modalEl = document.getElementById("assetModal");
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error("HTTP " + response.status);
            }
            return response.json();
        })
        .then(data => {
            loader.classList.add("d-none");

            if (!data.success) {
                errorBlock.textContent = "Помилка при отриманні списку активів: " + (data.error || "Невідома помилка");
                errorBlock.classList.remove("d-none");
                noDataMsg.classList.remove("d-none");
                return;
            }

            const assets = data.assets || [];
            assetsData = assets;  // зберігаємо

            if (assets.length === 0) {
                noDataMsg.classList.remove("d-none");
                return;
            }

            assets.forEach((a, index) => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between align-items-center py-1";

                const numSpan = document.createElement("span");
                numSpan.className = "text-muted me-2";
                numSpan.textContent = index + 1;

                // hostname як "посилання"
                const hostBtn = document.createElement("button");
                hostBtn.type = "button";
                hostBtn.className = "btn btn-link btn-sm p-0 text-decoration-none";
                hostBtn.textContent = a.hostname ?? "(без імені)";
                hostBtn.addEventListener("click", function () {
                    showAssetModal(a);
                });

                li.appendChild(numSpan);
                li.appendChild(hostBtn);
                list.appendChild(li);
            });
        })
        .catch(err => {
            loader.classList.add("d-none");
            errorBlock.textContent = "Помилка при завантаженні даних: " + err.message;
            errorBlock.classList.remove("d-none");
            noDataMsg.classList.remove("d-none");
        });
});
</script>


{% endblock %}

