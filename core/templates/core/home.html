{% extends "base.html" %}

{% block title %}Активи{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-3">Активи</h1>

    <p class="text-muted mb-2">
        Короткий список хостів (Wazuh + CrowdStrike).
    </p>

    <style>
        .log-block {
            max-height: 220px;
            overflow: auto;
        }
        .log-block code {
            font-size: 0.75rem;
            white-space: normal;
            word-break: break-word;
        }
        .unified-details-wrapper {
            background-color: #fafafa;
        }
    </style>

    {# ===================== УНІФІКОВАНІ АКТИВИ (ТАБЛИЦЯ + АКОРДЕОН) ===================== #}
    <h2 class="h4 mt-3 mb-2">Уніфіковані активи</h2>

    <div id="unified-error" class="alert alert-danger d-none"></div>

    <div id="unified-loader" class="d-flex align-items-center mb-2">
        <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Завантаження уніфікованого списку активів…</span>
    </div>

    <div class="card mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;"></th>
                            <th style="width: 40px;">#</th>
                            <th>Hostname</th>
                            <th style="width: 140px;">IP</th>
                            <th style="width: 150px;">Платформа</th>
                            <th style="width: 160px;">Джерела</th>
                            <th style="width: 110px;">Ризик</th>
                        </tr>
                    </thead>
                    <tbody id="unified-assets-tbody">
                        <!-- JS сюди додасть рядки -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <p id="unified-no-data" class="text-muted mt-2 d-none">
        Поки що немає даних про активи.
    </p>

    {# ===================== ЕПІЗОДИ ПОДІЙ (WAZUH + CROWDSTRIKE) ===================== #}
    <h2 class="h4 mt-4 mb-2">Епізоди подій (Wazuh + CrowdStrike)</h2>

    <div id="episodes-error" class="alert alert-danger d-none"></div>

    <div id="episodes-loader" class="d-flex align-items-center mb-2">
        <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Агрегація подій по хостам…</span>
    </div>

    <div class="card mb-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>Hostname</th>
                            <th style="width: 210px;">Інтервал</th>
                            <th style="width: 90px;">Тривалість</th>
                            <th style="width: 120px;">Подій</th>
                            <th style="width: 120px;">Wazuh / CS</th>
                            <th style="width: 110px;">Макс. рівень</th>
                        </tr>
                    </thead>
                    <tbody id="episodes-tbody">
                        <!-- JS сюди додасть епізоди -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <p id="episodes-no-data" class="text-muted mt-2 d-none">
        Поки що немає зведених епізодів подій.
    </p>

    {# ===================== WAZUH HOSTS ===================== #}
    <h2 class="h4 mt-3 mb-2">Wazuh – агенти</h2>

    <div id="wazuh-error-block" class="alert alert-danger d-none"></div>

    <div id="wazuh-loader" class="d-flex align-items-center mb-2">
        <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Завантаження хостів Wazuh…</span>
    </div>

    <div class="card" style="max-width: 700px;">
        <div class="card-body p-2">
            <ul id="wazuh-hosts-list" class="list-group list-group-flush small">
                <!-- JS -->
            </ul>
        </div>
    </div>

    <p id="wazuh-no-data-msg" class="text-muted mt-2 d-none">
        Поки що немає даних про хости Wazuh.
    </p>

    {# ===================== CROWDSTRIKE / АКТИВИ ===================== #}
    <h2 class="h4 mt-4 mb-2">CrowdStrike – активи</h2>

    <div id="cs-error-block" class="alert alert-danger d-none"></div>

    <div id="cs-loader" class="d-flex align-items-center mb-2">
        <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Завантаження списку активів CrowdStrike…</span>
    </div>

    <div class="card" style="max-width: 700px;">
        <div class="card-body p-2">
            <ul id="assets-list" class="list-group list-group-flush small">
                <!-- JS -->
            </ul>
        </div>
    </div>

    <p id="cs-no-data-msg" class="text-muted mt-2 d-none">
        Поки що немає даних про активи CrowdStrike.
    </p>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // ===== helpers =====
    function getSeverityBadgeClass(sev) {
        if (!sev) return "bg-secondary";
        switch (sev.toLowerCase()) {
            case "low": return "bg-success";
            case "medium": return "bg-warning";
            case "high": return "bg-danger";
            case "critical": return "bg-dark";
            default: return "bg-secondary";
        }
    }

    function mapWazuhLevelToSeverity(level) {
        if (level == null) return "unknown";
        const lvl = Number(level);
        if (lvl <= 3) return "low";
        if (lvl <= 7) return "medium";
        if (lvl <= 11) return "high";
        return "critical";
    }

    function formatLogText(raw) {
        if (!raw) return "";
        let text = String(raw);
        text = text
            .replace(/\\r\\n/g, "\n")
            .replace(/\\n/g, "\n")
            .replace(/\\t/g, "    ");
        text = text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        text = text.replace(/\r?\n/g, "<br>");
        return text;
    }

    function formatLocalDateTime(iso) {
        if (!iso) return "";
        try {
            const d = new Date(iso);
            if (isNaN(d.getTime())) return iso;
            return d.toLocaleString();
        } catch (e) {
            return iso;
        }
    }

    // ===== УНІФІКОВАНІ АКТИВИ: елемент логу (Wazuh / CS / інше) =====
    function buildUnifiedLogItem(log) {
        const li = document.createElement("li");
        li.className = "mb-2 p-2 border rounded";

        const src = log.source || "other";
        const raw = log.raw || {};

        let severityText = "unknown";
        let sevClass = "bg-secondary";
        let titleText = "";
        let category = "";
        let ts = "";
        let idText = "";
        let extraLine = "";
        let fullLog = "";

        if (src === "wazuh") {
            const level = (raw.rule && raw.rule.level) || raw.level || null;
            severityText = mapWazuhLevelToSeverity(level);
            sevClass = getSeverityBadgeClass(severityText);

            titleText = (raw.rule && raw.rule.description) || raw.description || "";
            category =
                (raw.rule && raw.rule.groups && raw.rule.groups.join(", ")) ||
                raw.category || "";
            ts = raw.timestamp || raw.datetime || raw.time || "";
            idText = ((raw.rule && raw.rule.id) || raw.rule_id || "") +
                     ((raw.id || raw.event_id) ? " / " + (raw.id || raw.event_id) : "");
            const srcIp = raw.srcip || raw.src_ip || "";
            const dstIp = raw.dstip || raw.dst_ip || "";
            if (srcIp || dstIp) {
                extraLine = "";
                if (srcIp) extraLine += 'SRC: <span class="text-muted">' + srcIp + '</span> ';
                if (dstIp) extraLine += 'DST: <span class="text-muted">' + dstIp + '</span>';
            }
            fullLog = raw.full_log || raw.log || raw.message || "";

        } else if (src === "crowdstrike") {
            const sev = raw.severity || "unknown";
            severityText = sev;
            sevClass = getSeverityBadgeClass(sev);

            titleText = raw.title || raw.name || "";
            category = (raw.tactic || "") + (raw.technique ? " / " + raw.technique : "");
            ts = raw.start_time || raw.timestamp || "";
            idText = raw.id || raw.detect_id || "";
            if (raw.policy_name || raw.rule_name) {
                extraLine = 'Policy: <span class="text-muted">' +
                            (raw.policy_name || raw.rule_name) + '</span>';
            }
            fullLog = raw.description || raw.summary || "";
        } else {
            severityText = raw.severity || "unknown";
            sevClass = getSeverityBadgeClass(severityText);
            titleText = raw.title || raw.message || "";
            ts = raw.timestamp || "";
            idText = raw.id || "";
            fullLog = raw.description || raw.summary || raw.message || "";
        }

        let inner = '';
        inner += '<div class="d-flex justify-content-between align-items-start">';
        inner += '  <div>';
        inner += '    <span class="badge ' + sevClass + ' me-1 text-uppercase">' +
                    severityText + '</span>';
        inner += '    <span class="badge bg-info-subtle text-dark border ms-1">' +
                    (src === "wazuh" ? "Wazuh" :
                     src === "crowdstrike" ? "CrowdStrike" : src) +
                 '</span>';
        if (titleText) {
            inner += '    <div class="fw-semibold mt-1">' + titleText + '</div>';
        }
        if (category) {
            inner += '    <div class="small text-muted">' + category + '</div>';
        }
        if (extraLine) {
            inner += '    <div class="small">' + extraLine + '</div>';
        }
        if (fullLog) {
            inner += '    <div class="small mt-1 text-muted log-block"><code>' +
                     formatLogText(fullLog) +
                     '</code></div>';
        }
        inner += '  </div>';
        if (ts) {
            inner += '  <div class="text-end small text-muted ms-2">' + ts + '</div>';
        }
        inner += '</div>';
        if (idText) {
            inner += '<div class="small text-muted mt-1">ID: ' + idText + '</div>';
        }

        li.innerHTML = inner;
        return li;
    }

    // ===== УНІФІКОВАНІ АКТИВИ: побудова контенту акордеону по активу =====
    function buildUnifiedDetailsContent(container, asset) {
        container.innerHTML = "";

        const hostname = asset.hostname || null;
        const sources = asset.sources || {};

        const wzLogs = [];
        const csLogs = [];
        const otherLogs = [];

        // Якщо бекенд поклав logs прямо в asset — використовуємо їх
        if (asset.logs && asset.logs.length) {
            asset.logs.forEach(function (log) {
                if (log.source === "wazuh") wzLogs.push(log);
                else if (log.source === "crowdstrike") csLogs.push(log);
                else otherLogs.push(log);
            });
        } else {
            // Інакше самі будуємо списки із вже завантажених wazuhEventsData / detectsData

            // --- Wazuh ---
            if (hostname && sources.wazuh) {
                if (!wazuhEventsLoaded && !wazuhEventsLoadError) {
                    container.innerHTML =
                        '<span class="text-muted">Події Wazuh ще завантажуються… Спробуйте за мить.</span>';
                    return;
                }
                if (wazuhEventsLoadError) {
                    container.innerHTML =
                        '<span class="text-danger">Помилка при завантаженні подій Wazuh: ' +
                        wazuhEventsLoadError + '</span>';
                    return;
                }

                const hostEvents = wazuhEventsData.filter(function (ev) {
                    const evHostname =
                        ev.hostname ||
                        ev.agent_name ||
                        (ev.agent && (ev.agent.name || ev.agent.hostname)) ||
                        null;
                    return evHostname === hostname;
                });

                hostEvents.forEach(function (ev) {
                    wzLogs.push({ source: "wazuh", raw: ev });
                });
            }

            // --- CrowdStrike ---
            if (hostname && sources.crowdstrike) {
                if (!detectsLoaded && !detectsLoadError) {
                    container.innerHTML =
                        '<span class="text-muted">Детекти CrowdStrike ще завантажуються… Спробуйте за мить.</span>';
                    return;
                }
                if (detectsLoadError) {
                    container.innerHTML =
                        '<span class="text-danger">Помилка при завантаженні детектів: ' +
                        detectsLoadError + '</span>';
                    return;
                }

                const hostDetects = detectsData.filter(function (d) {
                    const detHostname =
                        d.hostname ||
                        d.device_hostname ||
                        (d.device && d.device.hostname) ||
                        null;
                    return detHostname === hostname;
                });

                hostDetects.forEach(function (d) {
                    csLogs.push({ source: "crowdstrike", raw: d });
                });
            }
        }

        if (!wzLogs.length && !csLogs.length && !otherLogs.length) {
            container.innerHTML =
                '<span class="text-muted">Для цього активу подій не знайдено.</span>';
            return;
        }

        if (wzLogs.length) {
            const t = document.createElement("div");
            t.className = "fw-bold mb-1";
            t.textContent = "Події Wazuh";
            container.appendChild(t);

            const ul = document.createElement("ul");
            ul.className = "list-unstyled mb-2";
            wzLogs.forEach(function (log) { ul.appendChild(buildUnifiedLogItem(log)); });
            container.appendChild(ul);
        }

        if (csLogs.length) {
            const t = document.createElement("div");
            t.className = "fw-bold mt-2 mb-1";
            t.textContent = "Детекти CrowdStrike";
            container.appendChild(t);

            const ul = document.createElement("ul");
            ul.className = "list-unstyled mb-2";
            csLogs.forEach(function (log) { ul.appendChild(buildUnifiedLogItem(log)); });
            container.appendChild(ul);
        }

        if (otherLogs.length) {
            const t = document.createElement("div");
            t.className = "fw-bold mt-2 mb-1";
            t.textContent = "Інші джерела";
            container.appendChild(t);

            const ul = document.createElement("ul");
            ul.className = "list-unstyled mb-2";
            otherLogs.forEach(function (log) { ul.appendChild(buildUnifiedLogItem(log)); });
            container.appendChild(ul);
        }
    }

    function buildUnifiedRow(asset, index) {
        const frag = document.createDocumentFragment();

        const hostname = asset.hostname || "(без імені)";
        const ip = asset.ip || "—";
        const platform = asset.platform || asset.os || "—";

        const sources = asset.sources || {};
        const vendor = asset.vendor || "";
        const srcParts = [];
        if (sources.wazuh) srcParts.push("Wazuh");
        if (sources.crowdstrike) srcParts.push("CrowdStrike");
        if (!srcParts.length && vendor) srcParts.push(vendor);
        const srcText = srcParts.length ? srcParts.join(", ") : "—";

        let riskText = "—";
        if (asset.risk_score != null) {
            try {
                riskText = (asset.risk_score * 100).toFixed(0) + " %";
            } catch (e) {
                riskText = String(asset.risk_score);
            }
        }

        const mainTr = document.createElement("tr");
        const toggleTd = document.createElement("td");
        const toggleBtn = document.createElement("button");
        toggleBtn.type = "button";
        toggleBtn.className = "btn btn-sm btn-light border-0";
        toggleBtn.textContent = "▶";
        toggleBtn.setAttribute("aria-expanded", "false");
        toggleTd.appendChild(toggleBtn);

        const numTd = document.createElement("td");
        numTd.className = "text-muted";
        numTd.textContent = index + 1;

        const hostTd = document.createElement("td");
        hostTd.innerHTML = '<span class="fw-semibold">' + hostname + '</span>';

        const ipTd = document.createElement("td");
        ipTd.innerHTML = '<code>' + ip + '</code>';

        const platTd = document.createElement("td");
        platTd.textContent = platform;

        const srcTd = document.createElement("td");
        srcTd.textContent = srcText;

        const riskTd = document.createElement("td");
        riskTd.textContent = riskText;

        mainTr.appendChild(toggleTd);
        mainTr.appendChild(numTd);
        mainTr.appendChild(hostTd);
        mainTr.appendChild(ipTd);
        mainTr.appendChild(platTd);
        mainTr.appendChild(srcTd);
        mainTr.appendChild(riskTd);

        const detailsTr = document.createElement("tr");
        detailsTr.className = "d-none unified-details-wrapper";
        const detailsTd = document.createElement("td");
        detailsTd.colSpan = 7;
        const detailsContainer = document.createElement("div");
        detailsContainer.className = "pt-2 small";
        detailsTd.appendChild(detailsContainer);
        detailsTr.appendChild(detailsTd);

        toggleBtn.addEventListener("click", function () {
            const isOpen = !detailsTr.classList.contains("d-none");
            if (isOpen) {
                detailsTr.classList.add("d-none");
                toggleBtn.textContent = "▶";
                toggleBtn.setAttribute("aria-expanded", "false");
            } else {
                if (!detailsTr.dataset.loaded) {
                    buildUnifiedDetailsContent(detailsContainer, asset);
                    detailsTr.dataset.loaded = "1";
                }
                detailsTr.classList.remove("d-none");
                toggleBtn.textContent = "▼";
                toggleBtn.setAttribute("aria-expanded", "true");
            }
        });

        frag.appendChild(mainTr);
        frag.appendChild(detailsTr);
        return frag;
    }

    // ===== ЕПІЗОДИ: деталі епізоду =====
    function buildEpisodeDetailsContent(container, episode) {
        container.innerHTML = "";

        const metaDiv = document.createElement("div");
        metaDiv.className = "mb-2 small";

        const host = episode.hostname || "(unknown)";
        const start = formatLocalDateTime(episode.start_time);
        const end = formatLocalDateTime(episode.end_time);
        const dur = Math.round(episode.duration_sec || 0);
        const nWz = episode.num_events_wazuh || 0;
        const nCs = episode.num_events_crowdstrike || 0;

        metaDiv.innerHTML =
            '<div><strong>Hostname:</strong> ' + host + '</div>' +
            '<div><strong>Інтервал:</strong> ' + start + ' — ' + end + '</div>' +
            '<div><strong>Тривалість:</strong> ' + dur + ' с</div>' +
            '<div><strong>Події:</strong> всього ' + (episode.num_events || 0) +
            ' (Wazuh: ' + nWz + ', CrowdStrike: ' + nCs + ')</div>';

        container.appendChild(metaDiv);

        const title = document.createElement("div");
        title.className = "fw-bold mb-1";
        title.textContent = "Події в епізоді";
        container.appendChild(title);

        if (!episode.events || !episode.events.length) {
            const span = document.createElement("span");
            span.className = "text-muted small";
            span.textContent = "Немає подій у цьому епізоді.";
            container.appendChild(span);
            return;
        }

        const ul = document.createElement("ul");
        ul.className = "list-unstyled mb-0";

        episode.events.forEach(function (ev) {
            const logObj = {
                source: ev.source || "other",
                raw: ev.raw || ev
            };
            ul.appendChild(buildUnifiedLogItem(logObj));
        });

        container.appendChild(ul);
    }

    function buildEpisodeRow(episode, index) {
        const frag = document.createDocumentFragment();

        const mainTr = document.createElement("tr");

        const toggleTd = document.createElement("td");
        const toggleBtn = document.createElement("button");
        toggleBtn.type = "button";
        toggleBtn.className = "btn btn-sm btn-light border-0";
        toggleBtn.textContent = "▶";
        toggleBtn.setAttribute("aria-expanded", "false");
        toggleTd.appendChild(toggleBtn);

        const hostTd = document.createElement("td");
        hostTd.innerHTML = '<span class="fw-semibold">' +
            (episode.hostname || "(без імені)") + '</span>';

        const windowTd = document.createElement("td");
        windowTd.className = "small";
        windowTd.innerHTML =
            formatLocalDateTime(episode.start_time) +
            '<br><span class="text-muted">&rarr; ' +
            formatLocalDateTime(episode.end_time) + '</span>';

        const durTd = document.createElement("td");
        durTd.className = "small";
        durTd.textContent = Math.round(episode.duration_sec || 0) + " с";

        const numTd = document.createElement("td");
        numTd.className = "small";
        numTd.textContent = episode.num_events || 0;

        const srcTd = document.createElement("td");
        srcTd.className = "small";
        srcTd.textContent =
            (episode.num_events_wazuh || 0) + " / " +
            (episode.num_events_crowdstrike || 0);

        const sevTd = document.createElement("td");
        const sev = episode.max_severity || "";
        if (sev) {
            const sevClass = getSeverityBadgeClass(sev);
            sevTd.innerHTML =
                '<span class="badge ' + sevClass + ' text-uppercase">' +
                sev + '</span>';
        } else {
            sevTd.innerHTML = '<span class="text-muted small">—</span>';
        }

        mainTr.appendChild(toggleTd);
        mainTr.appendChild(hostTd);
        mainTr.appendChild(windowTd);
        mainTr.appendChild(durTd);
        mainTr.appendChild(numTd);
        mainTr.appendChild(srcTd);
        mainTr.appendChild(sevTd);

        const detailsTr = document.createElement("tr");
        detailsTr.className = "d-none unified-details-wrapper";
        const detailsTd = document.createElement("td");
        detailsTd.colSpan = 7;
        const detailsContainer = document.createElement("div");
        detailsContainer.className = "pt-2 small";
        detailsTd.appendChild(detailsContainer);
        detailsTr.appendChild(detailsTd);

        toggleBtn.addEventListener("click", function () {
            const isOpen = !detailsTr.classList.contains("d-none");
            if (isOpen) {
                detailsTr.classList.add("d-none");
                toggleBtn.textContent = "▶";
                toggleBtn.setAttribute("aria-expanded", "false");
            } else {
                if (!detailsTr.dataset.loaded) {
                    buildEpisodeDetailsContent(detailsContainer, episode);
                    detailsTr.dataset.loaded = "1";
                }
                detailsTr.classList.remove("d-none");
                toggleBtn.textContent = "▼";
                toggleBtn.setAttribute("aria-expanded", "true");
            }
        });

        frag.appendChild(mainTr);
        frag.appendChild(detailsTr);
        return frag;
    }

    // ===== Wazuh hosts (нижній блок, як було) =====
    const wzLoader = document.getElementById("wazuh-loader");
    const wzErrorBlock = document.getElementById("wazuh-error-block");
    const wzNoDataMsg = document.getElementById("wazuh-no-data-msg");
    const wzList = document.getElementById("wazuh-hosts-list");

    let wazuhHostsData = [];
    let wazuhEventsData = [];
    let wazuhEventsLoaded = false;
    let wazuhEventsLoadError = null;

    const wazuhHostsUrl = "/wazuh/hosts/";
    const wazuhEventsUrl = "/wazuh/events/";

    function findHostnameInWazuhEvent(ev) {
        return (
            ev.hostname ||
            ev.agent_name ||
            (ev.agent && (ev.agent.name || ev.agent.hostname)) ||
            null
        );
    }

    function buildWazuhDetailsContent(container, host) {
        container.innerHTML = "";

        const infoDiv = document.createElement("div");
        infoDiv.className = "mb-2";

        const statusText = host.status || host.online_status || "—";
        const ipText = host.ip || host.ip_address || "—";
        const osName = (host.os && host.os.name) || host.os_name || "—";
        const osVersion = (host.os && host.os.version) || host.os_version || "";
        const agentId = host.agent_id || host.id || "—";

        let riskText = "—";
        if (host.risk_score != null) {
            riskText = (host.risk_score * 100).toFixed(0) + " %";
        }

        infoDiv.innerHTML =
            '<div><strong>IP:</strong> ' + ipText + '</div>' +
            '<div><strong>OS:</strong> ' + osName + (osVersion ? " " + osVersion : "") + '</div>' +
            '<div><strong>Статус агента:</strong> ' + statusText + '</div>' +
            '<div><strong>Ризик:</strong> ' + riskText + '</div>' +
            '<div><strong>Agent ID:</strong> ' + agentId + '</div>';

        container.appendChild(infoDiv);

        const evBlock = document.createElement("div");
        const title = document.createElement("div");
        title.className = "fw-bold mb-1";
        title.textContent = "Події Wazuh";
        evBlock.appendChild(title);

        const msgDiv = document.createElement("div");
        evBlock.appendChild(msgDiv);

        const ul = document.createElement("ul");
        ul.className = "list-unstyled mb-0";
        evBlock.appendChild(ul);

        container.appendChild(evBlock);

        const hostName = host.hostname || host.name;
        if (!hostName) {
            msgDiv.innerHTML =
                '<span class="text-muted">Немає hostname, щоб знайти події.</span>';
            return;
        }

        if (!wazuhEventsLoaded && !wazuhEventsLoadError) {
            msgDiv.innerHTML =
                '<span class="text-muted">Події ще завантажуються… Спробуйте за мить.</span>';
            return;
        }

        if (wazuhEventsLoadError) {
            msgDiv.innerHTML =
                '<span class="text-danger">Помилка при завантаженні подій: ' +
                wazuhEventsLoadError + '</span>';
            return;
        }

        const hostEvents = wazuhEventsData.filter(function (ev) {
            const evHostname = findHostnameInWazuhEvent(ev);
            return evHostname === hostName;
        });

        if (hostEvents.length === 0) {
            msgDiv.innerHTML =
                '<span class="text-muted">Для цього хоста подій не знайдено.</span>';
            return;
        }

        msgDiv.innerHTML = "";

        hostEvents.forEach(function (ev) {
            const li = document.createElement("li");
            li.className = "mb-2 p-2 border rounded";

            const level = (ev.rule && ev.rule.level) || ev.level || null;
            const severityText = mapWazuhLevelToSeverity(level);
            const sevClass = getSeverityBadgeClass(severityText);

            const ruleId = (ev.rule && ev.rule.id) || ev.rule_id || "";
            const ruleDesc = (ev.rule && ev.rule.description) || ev.description || "";
            const category =
                (ev.rule && ev.rule.groups && ev.rule.groups.join(", ")) ||
                ev.category || "";
            const ts = ev.timestamp || ev.datetime || ev.time || "";
            const eventId = ev.id || ev.event_id || "";
            const srcIp = ev.srcip || ev.src_ip || "";
            const dstIp = ev.dstip || ev.dst_ip || "";
            const fullLog = ev.full_log || ev.log || ev.message || "";

            let inner = "";
            inner += '<div class="d-flex justify-content-between align-items-start">';
            inner += '  <div>';
            inner += '    <span class="badge ' + sevClass + ' me-1 text-uppercase">' +
                        severityText + '</span>';
            if (level != null) {
                inner += '    <span class="text-muted small">level ' + level + '</span>';
            }
            if (ruleDesc) {
                inner += '    <div class="fw-semibold">' + ruleDesc + '</div>';
            }
            if (category) {
                inner += '    <div class="small text-muted">Категорія: ' + category + '</div>';
            }
            if (srcIp || dstIp) {
                inner += '    <div class="small">';
                if (srcIp) inner += 'SRC: <span class="text-muted">' + srcIp + '</span> ';
                if (dstIp) inner += 'DST: <span class="text-muted">' + dstIp + '</span>';
                inner += '    </div>';
            }
            if (fullLog) {
                inner += '    <div class="small mt-1 text-muted log-block"><code>' +
                         formatLogText(fullLog) +
                         '</code></div>';
            }
            inner += '  </div>';
            if (ts) {
                inner += '  <div class="text-end small text-muted ms-2">' + ts + '</div>';
            }
            inner += '</div>';
            if (ruleId || eventId) {
                inner += '<div class="small text-muted mt-1">';
                if (ruleId) inner += 'Rule ID: ' + ruleId + ' ';
                if (eventId) inner += 'Event ID: ' + eventId;
                inner += '</div>';
            }

            li.innerHTML = inner;
            ul.appendChild(li);
        });
    }

    function createWazuhHostRow(host, index) {
        const li = document.createElement("li");
        li.className = "list-group-item py-1";

        const header = document.createElement("div");
        header.className = "d-flex justify-content-between align-items-center";

        const left = document.createElement("div");
        left.className = "d-flex align-items-center";

        const numSpan = document.createElement("span");
        numSpan.className = "text-muted me-2";
        numSpan.textContent = index + 1;

        const hostLabel = document.createElement("span");
        hostLabel.textContent = host.hostname || host.name || "(без імені)";
        hostLabel.className = "fw-semibold";

        left.appendChild(numSpan);
        left.appendChild(hostLabel);

        const toggleBtn = document.createElement("button");
        toggleBtn.type = "button";
        toggleBtn.className = "btn btn-sm btn-light border-0";
        toggleBtn.setAttribute("aria-expanded", "false");
        toggleBtn.textContent = "▶";

        header.appendChild(left);
        header.appendChild(toggleBtn);

        const details = document.createElement("div");
        details.className = "mt-2 small d-none";

        toggleBtn.addEventListener("click", function () {
            const isOpen = !details.classList.contains("d-none");
            if (isOpen) {
                details.classList.add("d-none");
                toggleBtn.textContent = "▶";
                toggleBtn.setAttribute("aria-expanded", "false");
            } else {
                buildWazuhDetailsContent(details, host);
                details.classList.remove("d-none");
                toggleBtn.textContent = "▼";
                toggleBtn.setAttribute("aria-expanded", "true");
            }
        });

        li.appendChild(header);
        li.appendChild(details);
        return li;
    }

    // Wazuh: хости
    fetch(wazuhHostsUrl)
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(data => {
            wzLoader.classList.add("d-none");
            if (!data.success) throw new Error(data.error || "Невідома помилка при отриманні хостів Wazuh");
            const hosts = data.hosts || data.agents || [];
            wazuhHostsData = hosts;
            if (!hosts.length) {
                wzNoDataMsg.classList.remove("d-none");
                return;
            }
            hosts.forEach((h, i) => wzList.appendChild(createWazuhHostRow(h, i)));
        })
        .catch(err => {
            wzLoader.classList.add("d-none");
            wzErrorBlock.textContent = "Помилка при завантаженні хостів Wazuh: " + err.message;
            wzErrorBlock.classList.remove("d-none");
            wzNoDataMsg.classList.remove("d-none");
        });

    // Wazuh: події
    fetch(wazuhEventsUrl)
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(data => {
            if (!data.success) throw new Error(data.error || "Невідома помилка при отриманні подій Wazuh");
            wazuhEventsData = data.events || data.alerts || [];
            wazuhEventsLoaded = true;
        })
        .catch(err => {
            wazuhEventsLoadError = err.message;
            wazuhEventsLoaded = true;
        });

    // ===== CrowdStrike / Unified assets =====
    const csLoader = document.getElementById("cs-loader");
    const csErrorBlock = document.getElementById("cs-error-block");
    const csNoDataMsg = document.getElementById("cs-no-data-msg");
    const csList = document.getElementById("assets-list");

    const unifiedLoader = document.getElementById("unified-loader");
    const unifiedError = document.getElementById("unified-error");
    const unifiedNoData = document.getElementById("unified-no-data");
    const unifiedTbody = document.getElementById("unified-assets-tbody");

    let assetsData = [];
    let detectsData = [];
    let detectsLoaded = false;
    let detectsLoadError = null;

    const assetsUrl = "/assets/data/";
    const detectsUrl = "/crowdstrike/detects/";

    function buildCsDetailsContent(container, asset) {
        container.innerHTML = "";

        const infoDiv = document.createElement("div");
        infoDiv.className = "mb-2";

        const statusText =
            asset.online_status === "online" ? "Online" :
            asset.online_status === "offline" ? "Offline" :
            asset.online_status === "unknown" ? "Unknown" : "—";

        let riskText = "—";
        if (asset.risk_score != null) {
            riskText = (asset.risk_score * 100).toFixed(0) + " %";
        }

        infoDiv.innerHTML =
            '<div><strong>IP:</strong> ' + (asset.ip || "—") + '</div>' +
            '<div><strong>Платформа:</strong> ' + (asset.platform || "—") + '</div>' +
            '<div><strong>Вендор:</strong> ' + (asset.vendor || "—") + '</div>' +
            '<div><strong>Статус:</strong> ' + statusText + '</div>' +
            '<div><strong>Ризик:</strong> ' + riskText + '</div>';

        container.appendChild(infoDiv);

        const detBlock = document.createElement("div");
        const title = document.createElement("div");
        title.className = "fw-bold mb-1";
        title.textContent = "Детекти CrowdStrike";
        detBlock.appendChild(title);

        const msgDiv = document.createElement("div");
        detBlock.appendChild(msgDiv);

        const ul = document.createElement("ul");
        ul.className = "list-unstyled mb-0";
        detBlock.appendChild(ul);

        container.appendChild(detBlock);

        if (!asset.hostname) {
            msgDiv.innerHTML =
                '<span class="text-muted">Немає hostname, щоб знайти детекти.</span>';
            return;
        }

        if (!detectsLoaded && !detectsLoadError) {
            msgDiv.innerHTML =
                '<span class="text-muted">Детекти ще завантажуються… Спробуйте за мить.</span>';
            return;
        }

        if (detectsLoadError) {
            msgDiv.innerHTML =
                '<span class="text-danger">Помилка при завантаженні детектів: ' +
                detectsLoadError + '</span>';
            return;
        }

        const hostDetects = detectsData.filter(function (d) {
            const detHostname =
                d.hostname ||
                d.device_hostname ||
                (d.device && d.device.hostname) ||
                null;
            return detHostname === asset.hostname;
        });

        if (!hostDetects.length) {
            msgDiv.innerHTML =
                '<span class="text-muted">Для цього хоста детектів не знайдено.</span>';
            return;
        }

        msgDiv.innerHTML = "";

        hostDetects.forEach(function (d) {
            const li = document.createElement("li");
            li.className = "mb-2 p-2 border rounded";

            const sev = d.severity || "unknown";
            const sevClass = getSeverityBadgeClass(sev);
            const tactic = d.tactic || "";
            const technique = d.technique || "";
            const time = d.start_time || d.timestamp || "";
            const status = d.status || "";
            const id = d.id || d.detect_id || "";
            const titleText = d.title || d.name || "";
            const policy = d.policy_name || d.rule_name || "";
            const typeText = d.type || d.alert_type || d.event_type || "";
            const desc = d.description || d.summary || "";

            let inner = "";
            inner += '<div class="d-flex justify-content-between align-items-start">';
            inner += '  <div>';
            inner += '    <span class="badge ' + sevClass + ' me-1 text-uppercase">' + sev + '</span>';
            if (status) inner += '    <span class="text-muted small">' + status + '</span>';
            if (titleText) inner += '    <div class="fw-semibold">' + titleText + '</div>';
            if (typeText) inner += '    <div class="small">Тип: <span class="text-muted">' + typeText + '</span></div>';
            if (tactic || technique) inner += '    <div class="small text-muted">' + tactic + ' ' + technique + '</div>';
            if (policy) inner += '    <div class="small text-muted">Policy: ' + policy + '</div>';
            if (desc) inner += '    <div class="small mt-1">' + desc + '</div>';
            inner += '  </div>';
            if (time) inner += '  <div class="text-end small text-muted ms-2">' + time + '</div>';
            inner += '</div>';
            if (id) inner += '<div class="small text-muted mt-1">ID: ' + id + '</div>';

            li.innerHTML = inner;
            ul.appendChild(li);
        });
    }

    function createAssetRow(asset, index) {
        const li = document.createElement("li");
        li.className = "list-group-item py-1";

        const header = document.createElement("div");
        header.className = "d-flex justify-content-between align-items-center";

        const left = document.createElement("div");
        left.className = "d-flex align-items-center";

        const numSpan = document.createElement("span");
        numSpan.className = "text-muted me-2";
        numSpan.textContent = index + 1;

        const hostLabel = document.createElement("span");
        hostLabel.textContent = asset.hostname || "(без імені)";
        hostLabel.className = "fw-semibold";

        left.appendChild(numSpan);
        left.appendChild(hostLabel);

        const toggleBtn = document.createElement("button");
        toggleBtn.type = "button";
        toggleBtn.className = "btn btn-sm btn-light border-0";
        toggleBtn.setAttribute("aria-expanded", "false");
        toggleBtn.textContent = "▶";

        header.appendChild(left);
        header.appendChild(toggleBtn);

        const details = document.createElement("div");
        details.className = "mt-2 small d-none";

        toggleBtn.addEventListener("click", function () {
            const isOpen = !details.classList.contains("d-none");
            if (isOpen) {
                details.classList.add("d-none");
                toggleBtn.textContent = "▶";
                toggleBtn.setAttribute("aria-expanded", "false");
            } else {
                buildCsDetailsContent(details, asset);
                details.classList.remove("d-none");
                toggleBtn.textContent = "▼";
                toggleBtn.setAttribute("aria-expanded", "true");
            }
        });

        li.appendChild(header);
        li.appendChild(details);
        return li;
    }

    // Завантажуємо уніфіковані активи
    fetch(assetsUrl)
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(data => {
            unifiedLoader.classList.add("d-none");
            csLoader.classList.add("d-none");

            if (!data.success) throw new Error(data.error || "Невідома помилка при отриманні активів");

            const assets = data.assets || [];
            assetsData = assets;

            if (!assets.length) {
                unifiedNoData.classList.remove("d-none");
                csNoDataMsg.classList.remove("d-none");
                return;
            }

            // верхня таблиця
            assets.forEach(function (a, index) {
                unifiedTbody.appendChild(buildUnifiedRow(a, index));
            });

            // нижній блок CrowdStrike: тільки ті, де є sources.crowdstrike === true
            const csAssets = assets.filter(a => a.sources && a.sources.crowdstrike);
            if (!csAssets.length) {
                csNoDataMsg.classList.remove("d-none");
            } else {
                csAssets.forEach(function (a, index) {
                    csList.appendChild(createAssetRow(a, index));
                });
            }
        })
        .catch(err => {
            unifiedLoader.classList.add("d-none");
            csLoader.classList.add("d-none");

            unifiedError.textContent =
                "Помилка при завантаженні уніфікованих активів: " + err.message;
            unifiedError.classList.remove("d-none");
            unifiedNoData.classList.remove("d-none");

            csErrorBlock.textContent =
                "Помилка при завантаженні даних: " + err.message;
            csErrorBlock.classList.remove("d-none");
            csNoDataMsg.classList.remove("d-none");
        });

    // CrowdStrike детекти (для акордеонів)
    fetch(detectsUrl)
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(data => {
            if (!data.success) throw new Error(data.error || "Невідома помилка при отриманні детектів");
            detectsData = data.detects || [];
            detectsLoaded = true;
        })
        .catch(err => {
            detectsLoadError = err.message;
            detectsLoaded = true;
        });

    // ===== Епізоди подій (Wazuh + CrowdStrike) =====
    const episodesLoader = document.getElementById("episodes-loader");
    const episodesError = document.getElementById("episodes-error");
    const episodesNoData = document.getElementById("episodes-no-data");
    const episodesTbody = document.getElementById("episodes-tbody");

    const episodesUrl = "/events/episodes/?window_seconds=90&limit_per_source=200";

    fetch(episodesUrl)
        .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
        .then(data => {
            episodesLoader.classList.add("d-none");

            if (!data.success) throw new Error(data.error || "Невідома помилка при отриманні епізодів");

            const episodes = data.episodes || [];
            if (!episodes.length) {
                episodesNoData.classList.remove("d-none");
                return;
            }

            episodes.forEach(function (ep, index) {
                episodesTbody.appendChild(buildEpisodeRow(ep, index));
            });
        })
        .catch(err => {
            episodesLoader.classList.add("d-none");
            episodesError.textContent = "Помилка при завантаженні епізодів: " + err.message;
            episodesError.classList.remove("d-none");
            episodesNoData.classList.remove("d-none");
        });
});
</script>

{% endblock %}

