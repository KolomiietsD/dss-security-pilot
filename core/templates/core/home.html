{% extends "base.html" %}

{% block title %}Активи{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-3">Активи</h1>

    <p class="text-muted mb-2">
        Короткий список хостів (зараз тільки з CrowdStrike).
    </p>

    <!-- Блок для помилок -->
    <div id="error-block" class="alert alert-danger d-none"></div>

    <!-- Loader -->
    <div id="loader" class="d-flex align-items-center mb-2">
        <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <span>Завантаження списку активів…</span>
    </div>

    <!-- Список активів з акордеоном -->
    <div class="card" style="max-width: 700px;">
        <div class="card-body p-2">
            <ul id="assets-list" class="list-group list-group-flush small">
                <!-- JS сюди додасть елементи -->
            </ul>
        </div>
    </div>

    <p id="no-data-msg" class="text-muted mt-2 d-none">
        Поки що немає даних про активи.
    </p>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const loader = document.getElementById("loader");
    const errorBlock = document.getElementById("error-block");
    const noDataMsg = document.getElementById("no-data-msg");
    const list = document.getElementById("assets-list");

    // всі активи
    let assetsData = [];
    // всі детекти (спільний список з CrowdStrike)
    let detectsData = [];
    let detectsLoaded = false;
    let detectsLoadError = null;

    const assetsUrl = "/assets/data/";
    const detectsUrl = "/crowdstrike/detects/";  // endpoint, який у тебе вже є

    function findHostnameInDetect(d) {
        return (
            d.hostname ||
            d.device_hostname ||
            (d.device && d.device.hostname) ||
            null
        );
    }

    function getSeverityBadgeClass(sev) {
        if (!sev) return "bg-secondary";
        switch (sev.toLowerCase()) {
            case "low":
                return "bg-success";
            case "medium":
                return "bg-warning";
            case "high":
                return "bg-danger";
            case "critical":
                return "bg-dark";
            default:
                return "bg-secondary";
        }
    }

    function buildDetailsContent(container, asset) {
        container.innerHTML = "";

        // 1) Основна інфа по активу
        const infoDiv = document.createElement("div");
        infoDiv.className = "mb-2";

        const statusText =
            asset.online_status === "online" ? "Online" :
            asset.online_status === "offline" ? "Offline" :
            asset.online_status === "unknown" ? "Unknown" : "—";

        let riskText = "—";
        if (asset.risk_score != null) {
            riskText = (asset.risk_score * 100).toFixed(0) + " %";
        }

        infoDiv.innerHTML = ''
            + '<div><strong>IP:</strong> ' + (asset.ip || "—") + '</div>'
            + '<div><strong>Платформа:</strong> ' + (asset.platform || "—") + '</div>'
            + '<div><strong>Вендор:</strong> ' + (asset.vendor || "—") + '</div>'
            + '<div><strong>Статус:</strong> ' + statusText + '</div>'
            + '<div><strong>Ризик:</strong> ' + riskText + '</div>';

        container.appendChild(infoDiv);

        // 2) Блок детектів
        const detBlock = document.createElement("div");

        const title = document.createElement("div");
        title.className = "fw-bold mb-1";
        title.textContent = "Детекти";
        detBlock.appendChild(title);

        const msgDiv = document.createElement("div");
        detBlock.appendChild(msgDiv);

        const ul = document.createElement("ul");
        ul.className = "list-unstyled mb-0";
        detBlock.appendChild(ul);

        container.appendChild(detBlock);

        if (!asset.hostname) {
            msgDiv.innerHTML =
                '<span class="text-muted">Немає hostname, щоб знайти детекти.</span>';
            return;
        }

        if (!detectsLoaded && !detectsLoadError) {
            msgDiv.innerHTML =
                '<span class="text-muted">Детекти ще завантажуються… Спробуйте за мить.</span>';
            return;
        }

        if (detectsLoadError) {
            msgDiv.innerHTML =
                '<span class="text-danger">Помилка при завантаженні детектів: '
                + detectsLoadError +
                '</span>';
            return;
        }

        const hostDetects = detectsData.filter(function (d) {
            const detHostname = findHostnameInDetect(d);
            return detHostname === asset.hostname;
        });

        if (hostDetects.length === 0) {
            msgDiv.innerHTML =
                '<span class="text-muted">Для цього хоста детектів не знайдено.</span>';
            return;
        }

        msgDiv.innerHTML = ""; // чистимо повідомлення

                hostDetects.forEach(function (d) {
            const li = document.createElement("li");
            li.className = "mb-2 p-2 border rounded";

            const sev = d.severity || "unknown";
            const sevClass = getSeverityBadgeClass(sev);
            const tactic = d.tactic || "";
            const technique = d.technique || "";
            const time = d.start_time || d.timestamp || "";
            const status = d.status || "";
            const id = d.id || d.detect_id || "";
            const titleText = d.title || d.name || "";
            const policy = d.policy_name || d.rule_name || "";

            // НОВЕ: тип та опис
            const typeText = d.type || d.alert_type || d.event_type || "";
            const desc = d.description || d.summary || "";

            let inner = '';

            inner += '<div class="d-flex justify-content-between align-items-start">';
            inner += '  <div>';
            inner += '    <span class="badge ' + sevClass + ' me-1 text-uppercase">' + sev + '</span>';
            if (status) {
                inner += '    <span class="text-muted small">' + status + '</span>';
            }
            if (titleText) {
                inner += '    <div class="fw-semibold">' + titleText + '</div>';
            }
            if (typeText) {
                inner += '    <div class="small">Тип: <span class="text-muted">' + typeText + '</span></div>';
            }
            if (tactic || technique) {
                inner += '    <div class="small text-muted">' + tactic + ' ' + technique + '</div>';
            }
            if (policy) {
                inner += '    <div class="small text-muted">Policy: ' + policy + '</div>';
            }
            if (desc) {
                inner += '    <div class="small mt-1">' + desc + '</div>';
            }
            inner += '  </div>';
            if (time) {
                inner += '  <div class="text-end small text-muted ms-2">' + time + '</div>';
            }
            inner += '</div>';
            if (id) {
                inner += '<div class="small text-muted mt-1">ID: ' + id + '</div>';
            }

            li.innerHTML = inner;
            ul.appendChild(li);
        });

    }

    function createAssetRow(asset, index) {
        const li = document.createElement("li");
        li.className = "list-group-item py-1";

        // ШАПКА рядка (номер, hostname, стрілка)
        const header = document.createElement("div");
        header.className = "d-flex justify-content-between align-items-center";

        const left = document.createElement("div");
        left.className = "d-flex align-items-center";

        const numSpan = document.createElement("span");
        numSpan.className = "text-muted me-2";
        numSpan.textContent = index + 1;

        const hostLabel = document.createElement("span");
        hostLabel.textContent = asset.hostname || "(без імені)";
        hostLabel.className = "fw-semibold";

        left.appendChild(numSpan);
        left.appendChild(hostLabel);

        const toggleBtn = document.createElement("button");
        toggleBtn.type = "button";
        toggleBtn.className = "btn btn-sm btn-light border-0";
        toggleBtn.setAttribute("aria-expanded", "false");
        toggleBtn.textContent = "▶"; // закритий стан

        header.appendChild(left);
        header.appendChild(toggleBtn);

        // БЛОК, що розкривається
        const details = document.createElement("div");
        details.className = "mt-2 small d-none"; // сховано за замовчуванням

        // Логіка відкриття/закриття
        toggleBtn.addEventListener("click", function () {
            const isOpen = !details.classList.contains("d-none");

            if (isOpen) {
                // згорнути
                details.classList.add("d-none");
                toggleBtn.textContent = "▶";
                toggleBtn.setAttribute("aria-expanded", "false");
            } else {
                // розгорнути
                buildDetailsContent(details, asset);
                details.classList.remove("d-none");
                toggleBtn.textContent = "▼";
                toggleBtn.setAttribute("aria-expanded", "true");
            }
        });

        li.appendChild(header);
        li.appendChild(details);

        return li;
    }

    // 1) Завантажуємо активи
    fetch(assetsUrl)
        .then(function (response) {
            if (!response.ok) {
                throw new Error("HTTP " + response.status);
            }
            return response.json();
        })
        .then(function (data) {
            loader.classList.add("d-none");

            if (!data.success) {
                throw new Error(data.error || "Невідома помилка при отриманні активів");
            }

            const assets = data.assets || [];
            assetsData = assets;

            if (assets.length === 0) {
                noDataMsg.classList.remove("d-none");
                return;
            }

            assets.forEach(function (a, index) {
                const li = createAssetRow(a, index);
                list.appendChild(li);
            });
        })
        .catch(function (err) {
            loader.classList.add("d-none");
            errorBlock.textContent = "Помилка при завантаженні даних: " + err.message;
            errorBlock.classList.remove("d-none");
            noDataMsg.classList.remove("d-none");
        });

    // 2) Паралельно у фоні тягнемо всі недавні детекти CrowdStrike
    fetch(detectsUrl)
        .then(function (response) {
            if (!response.ok) {
                throw new Error("HTTP " + response.status);
            }
            return response.json();
        })
        .then(function (data) {
            if (!data.success) {
                throw new Error(data.error || "Невідома помилка при отриманні детектів");
            }
            detectsData = data.detects || [];
            detectsLoaded = true;
        })
        .catch(function (err) {
            detectsLoadError = err.message;
            detectsLoaded = true;  // щоб не висіти в "проміжному" стані
        });
});
</script>

{% endblock %}




